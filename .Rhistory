<<<<<<< Updated upstream
################################################################################
# Description: Script to combine TPP & ONS data for deaths, imd, and age
#
# input: /output/cohorts/input.csv.gz
#        /data/imd_ons.csv.gz
#        /data/age_ons_sex.csv.gz
#        /data/ethnicity_ons.csv.gz
#
# output: /output/tables/age_sex_count.csv.gz
#         /output/tables/age_count.csv.gz
#         /output/tables/imd_count.csv.gz
#         /output/tables/ethnic_group.csv
#
# Author: Colm D Andrews
# Date: 31/01/2022
#
################################################################################
## import libraries
library('tidyverse')
library('gtsummary')
library('ggalluvial')
fs::dir_create(here::here("output","tables"))
fs::dir_create(here::here("output","plots"))
# # import data
df_input <- arrow::read_feather(file.path(here::here("output","data","input.feather"))) %>%
mutate(age_band = factor(age_band,levels=c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")),
sex = case_when(sex=="F"~"Female",sex=="M"~"Male"),
ethnicity_snomed_5=case_when(
ethnicity_snomed_5 == "1" ~ "White",
ethnicity_snomed_5 == "2" ~ "Mixed",
ethnicity_snomed_5 == "3" ~ "Asian",
ethnicity_snomed_5 == "4" ~ "Black",
ethnicity_snomed_5 == "5" ~ "Other"),
ethnicity_5=case_when(
ethnicity_5 == "1" ~ "White",
ethnicity_5 == "2" ~ "Mixed",
ethnicity_5 == "3" ~ "Asian",
ethnicity_5 == "4" ~ "Black",
ethnicity_5 == "5" ~ "Other")) %>%
filter(white_count>=0,black_count>=0,asian_count>=0, other_count>=0,mixed_count>=0)
matches<-df_input %>%
gather(common, cnt, ends_with("count")) %>%
group_by(patient_id) %>%
filter(cnt == max(cnt)) %>% # top_n(cnt, n = 1) also works
arrange(patient_id) %>%
ungroup() %>%
mutate(common = gsub("\\_.*", "", common),
match=ifelse(common==tolower(ethnicity_snomed_5),"Matching","Not matching"))
matches_table <- matches %>%
select(match,ethnicity_snomed_5) %>%
tbl_summary(by= match,
label = ethnicity_snomed_5 ~ "Latest SNOMED") %>%
bold_labels()
saveRDS(matches_table, here::here("output", "tables","matches.rds"))
matches_full_table <- matches %>%
select(common,ethnicity_snomed_5) %>%
tbl_summary(by= common,
label = list(ethnicity_snomed_5 ~ "Latest",common ~ "Most frequent")) %>%
bold_labels()
saveRDS(matches_full_table, here::here("output", "tables","matches_expanded.rds"))
definitions <- c("ctv3_yn","snomed_yn")
demographic_covariates <- c('age_band', 'sex', 'region', 'imd')
clinical_covariates <-  c('dementia', 'diabetes', 'hypertension', 'learning_disability')
set_table <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "**{level}** N =<br>{n} ({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
saveRDS(DF, here::here("output", "tables",paste0(name,".rds")))
assign(name,DF,envir = .GlobalEnv)
}
full_table<-df_input %>%
mutate(ctv3_yn = ifelse(is.na(ethnicity_5), "missing", "has value"),
snomed_yn = ifelse(is.na(ethnicity_snomed_5), "missing", "has value"),
missing = case_when(ctv3_yn =="missing" & snomed_yn=="missing" ~ "Both",
ctv3_yn =="missing" ~ "CTV3",
snomed_yn=="missing" ~ "SNOMED",
T~"Neither"),
missing = factor(missing,levels =c("Both","CTV3","SNOMED","Neither") )) %>%
mutate_at(clinical_covariates, function (x)(ifelse(x==FALSE,"False","True")))
set_table("full_missing",full_table,"snomed_yn","**Missing Ethnicity**")
set_table("full_missing_compare",full_table,"missing","**Missing Ethnicity**")
set_table("full_SNOMED",full_table,"ethnicity_snomed_5","**SNOMED Ethnicity**")
set_table("full_CTV3",full_table,"ethnicity_5","**CTV3 Ethnicity**")
set_table2 <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "N={n}<br>({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
assign(name,DF,envir = .GlobalEnv)
}
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table2(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3<br>Asian**",
"**SNOMED<br>Black**", "**CTV3<br>Black**",
"**SNOMED<br>Mixed**", "**CTV3<br>Mixed**",
"**SNOMED<br>Other**", "**CTV3<br>Other**",
"**SNOMED<br>White**", "**CTV3<br>White**"))  #%>%
saveRDS(compare, here::here("output", "tables","full_compare.rds"))
#### combined SNOMED and CTV3
theme_gtsummary_compact()
ethnicity_compare<-tbl_merge( list(full_SNOMED,full_CTV3),
tab_spanner = c("**SNOMED**", "**CTV3**"))
saveRDS(ethnicity_compare, here::here("output", "tables","full_ethnicity_compare.rds"))
##### Registered only
reg_table<-full_table %>%
filter(registered==T)
set_table("reg_missing",reg_table,"snomed_yn","**Missing Ethnicity**")
set_table("reg_missing_compare",reg_table,"missing","**Missing Ethnicity**")
set_table("reg_SNOMED",reg_table,"ethnicity_snomed_5","**SNOMED Ethnicity**")
set_table("reg_CTV3",reg_table,"ethnicity_5","**CTV3 Ethnicity**")
#### combined SNOMED and CTV3
theme_gtsummary_compact()
ethnicity_compare<-tbl_merge( list(reg_SNOMED,reg_CTV3),
tab_spanner = c("**SNOMED**", "**CTV3**"))
saveRDS(ethnicity_compare, here::here("output", "tables","reg_ethnicity_compare.rds"))
#  ################ Ethnicity
#
eth_ons<-read_csv(here::here("data","ethnicity_ons.csv.gz"))
eth_tpp <- df_input %>%
rename("Ethnic_Group"="ethnicity_snomed_5") %>%
group_by(region,Ethnic_Group) %>%
summarise(N=n()) %>%
ungroup %>%
group_by(region) %>%
mutate(Total = sum(N),
cohort="SNOMED",
group="5_2001")
#
# eth_tpp_16 <- df_input %>%
#   mutate(Ethnic_Group=case_when(
#     ethnicity_16 == "1" ~ "White British",
#     ethnicity_16 == "2" ~ "White Irish",
#     ethnicity_16 == "3" ~ "Other White",
#     ethnicity_16 == "4" ~ "White and Black Caribbean",
#     ethnicity_16 == "5" ~ "White and Black African",
#     ethnicity_16 == "6" ~ "White and Asian",
#     ethnicity_16 == "7" ~ "Other Mixed",
#     ethnicity_16 == "8" ~ "Indian",
#     ethnicity_16 == "9" ~ "Pakistani",
#     ethnicity_16 == "10" ~ "Bangladeshi",
#     ethnicity_16 == "11" ~ "Other Asian",
#     ethnicity_16 == "12" ~ "Caribbean",
#     ethnicity_16 == "13" ~ "African",
#     ethnicity_16 == "14" ~ "Other Black",
#     ethnicity_16 == "15" ~ "Chinese",
#     ethnicity_16 == "16" ~ "Any other ethnic group"))  %>%
#   group_by(region,Ethnic_Group) %>%
#   summarise(N=n()) %>%
#   ungroup %>%
#   group_by(region) %>%
#   mutate(Total = sum(N),
#          cohort="TPP",
#          group="16_2001")
#
ethnicity<-  eth_tpp %>%
bind_rows(eth_ons) %>%
mutate(
region=case_when(region=="East"~as.character("East of England"),
region=="Yorkshire and The Humber"~as.character("Yorkshire and the Humber"),
T~as.character(region)))
# %>%
#  bind_rows(eth_tpp_16)
### Add England
ethnicity_unrounded <-ethnicity %>%
group_by(group,Ethnic_Group,cohort) %>%
summarise(N=sum(N)) %>%
group_by(group,cohort) %>%
mutate(N=N,
Total=sum(N),
region="England") %>%
bind_rows(ethnicity)
ethnicity2 <- ethnicity_unrounded %>%
## add rounding
mutate(N=round(N/5)*5,
Total=round(Total/5)*5,
percentage=N/Total * 100)
write_csv(ethnicity2,here::here("output", "tables","ethnic_group.csv"))
#### NA removed
ethnicity_na<-ethnicity_unrounded %>%
drop_na(Ethnic_Group) %>%
group_by(group,cohort, region) %>%
mutate(
Total=sum(N),
N=round(N/5)*5,
Total=round(Total/5)*5,
percentage=N/Total * 100)
write_csv(ethnicity_na,here::here("output", "tables","ethnic_group_NA.csv"))
ethnicity_plot <- ethnicity_na %>%
filter(region != "England", group == "5_2001") %>%
ggplot(aes(x = Ethnic_Group, y = percentage, fill = cohort)) +
geom_bar(stat = "identity", position = "dodge") +
facet_wrap( ~ region) +
theme_classic() +
theme(text = element_text(size = 20)) +
theme(axis.text.x = element_text(
size = 20,
hjust = 0,
vjust = 0
)) +
coord_flip() +
xlab("") + ylab("Percentage of all ethnicities")
ggsave(
filename = here::here("output", "plots", "ethnicity_count.png"),
ethnicity_plot,
dpi = 600,
width = 45,
height = 30,
units = "cm"
)
#### ggalluvial
alluvial_data<-df_input %>%
gather(common, cnt, ends_with("count")) %>%
group_by(patient_id) %>%
top_n(cnt, n = 5) %>%
arrange(patient_id,-cnt) %>%
group_by(patient_id) %>%
mutate(rank=row_number()) %>%
mutate(common=ifelse(cnt==0,NA,common))
alluvial<- alluvial_data %>%
fill(common) %>%
drop_na(common) %>%
select(common,rank,patient_id) %>%
ggplot(
aes(x = rank, stratum = common, alluvium = patient_id,
fill = common, label = common)) +
scale_fill_brewer(type = "qual", palette = "Set2") +
geom_flow(stat = "alluvium", lode.guidance = "frontback",
color = "darkgray") +
geom_alluvium(aes(fill=common,alpha=0.5)) +
geom_stratum() +
theme(legend.position = "bottom") +
ggtitle("Ethnicity")
=======
head(majors_alluvia)
is_alluvia_form(majors_alluvia, tidyselect::starts_with("CURR"))
is_lodes_form(majors,
key = "semester", value = "curriculum", id = "student")
gg <- ggplot(majors_alluvia,
aes(axis1 = CURR1, axis2 = CURR7, axis3 = CURR13))
gg +
geom_alluvium(aes(fill = as.factor(student)), width = 2/5, discern = TRUE) +
geom_stratum(width = 2/5, discern = TRUE) +
geom_text(stat = "stratum", discern = TRUE, aes(label = after_stat(stratum)))
gg +
geom_alluvium(aes(fill = as.factor(student)), width = 2/5, discern = FALSE) +
geom_stratum(width = 2/5, discern = FALSE) +
geom_text(stat = "stratum", discern = FALSE, aes(label = after_stat(stratum)))
#
gg <- ggplot(majors_alluvia,
aes(axis1 = CURR1, axis2 = CURR7, axis3 = CURR13))
gg +
geom_alluvium(aes(fill = as.factor(student)), width = 2/5, discern = TRUE) +
geom_stratum(width = 2/5, discern = TRUE) +
geom_text(stat = "stratum", discern = TRUE, aes(label = after_stat(stratum)))
gg +
geom_alluvium(aes(fill = as.factor(student)), width = 2/5, discern = TRUE) +
geom_stratum(width = 2/5, discern = FALSE) +
geom_text(stat = "stratum", discern = FALSE, aes(label = after_stat(stratum)))
#
datalong <-read_csv(here::here("output","input_eth.csv"))
datalong3<-datalong %>%
select(starts_with("eth_")) %>%
mutate(across(where(is.numeric), ~+as.logical(.x))) %>%
rowwise() %>%
mutate(across(everything(), ~case_when(. == 1 ~ cur_column()), .names = 'new_{col}'))%>%
mutate(ethnicities = sum(c_across(starts_with("eth_")), na.rm = T)) %>%
unite(New_Col, starts_with('new_'), na.rm = TRUE, sep = ',')
datalong3<-datalong3%>%
separate("New_Col",fill="right",sep = ',',into=c(paste0("col_",1:max(datalong3$ethnicities))))  %>%
mutate(across(starts_with("col"), ~ ifelse(is.na(.), coalesce(!!!select(., rev(starts_with("col")))), .))) %>%
na_if("") %>% drop_na(col_1)
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number())
data3
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
plot <- ggplot(data4, aes(x = wave, y = n,
stratum = key, fill = key,
alluvium = id)) +
geom_stratum(alpha = .5) +
geom_flow() +
scale_fill_manual(values=c("red1","red3","red4", "blue1","blue3","blue4","darkslateblue", "chartreuse","chartreuse3","chartreuse4","darkgreen","yellow1","yellow2","yellow4","deeppink","deeppink4"))
plot
View(data4)
datalong <-read_csv(here::here("output","input_eth.csv"))
View(datalong)
datalong3<-datalong %>%
select(starts_with("eth_")) %>%
mutate(across(where(is.numeric), ~+as.logical(.x))) %>%
rowwise() %>%
mutate(across(everything(), ~case_when(. == 1 ~ cur_column()), .names = 'new_{col}'))%>%
mutate(ethnicities = sum(c_across(starts_with("eth_")), na.rm = T)) %>%
unite(New_Col, starts_with('new_'), na.rm = TRUE, sep = ',')
View(datalong3)
datalong3<-datalong3%>%
separate("New_Col",fill="right",sep = ',',into=c(paste0("col_",1:max(datalong3$ethnicities))))  %>%
mutate(across(starts_with("col"), ~ ifelse(is.na(.), coalesce(!!!select(., rev(starts_with("col")))), .))) %>%
na_if("") %>% drop_na(col_1)
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number())
View(data2)
? count
data2 <- datalong3 %>%
summarise(id = row_number(),
n = ethnicities)
data3 <- gather(data2, value, key, -n, -id)
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
data2 <- datalong3 %>%
mutate(id = row_number()) %>%
rename(
"n" = "ethnicities")
data3 <- gather(data2, value, key, -n, -id)
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number())
head(data2)
data2 <- datalong3 %>%
mutate(id = row_number()) %>%
rename("n" = "ethnicities") %>%
select(start_with("col"),id,n)
data2 <- datalong3 %>%
mutate(id = row_number()) %>%
rename("n" = "ethnicities") %>%
select(starts_with("col"),id,n)
data3 <- gather(data2, value, key, -n, -id)
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
plot <- ggplot(data4, aes(x = wave, y = n,
stratum = key, fill = key,
alluvium = id)) +
geom_stratum(alpha = .5) +
geom_flow() +
scale_fill_manual(values=c("red1","red3","red4", "blue1","blue3","blue4","darkslateblue", "chartreuse","chartreuse3","chartreuse4","darkgreen","yellow1","yellow2","yellow4","deeppink","deeppink4"))
plot
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number())
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number())
data2[which(data$col_1=="Eth_1" & data$col_11=="Eth_1"),]
data2[,which(data$col_1=="Eth_1" & data$col_11=="Eth_1")]
data2[,which(data2$col_1=="Eth_1" & data2$col_11=="Eth_1")]
data2[which(data2$col_1=="Eth_1" & data2$col_11=="Eth_1"),]
View(data2[which(data2$col_1=="Eth_1" & data2$col_11=="Eth_1"),])
a<-c(c(1,2,3),c(1,2,3),c(1,2,3))
a
a<-cbind.data.frame(c(1,2,3),c(1,2,3),c(1,2,3))
a
a %>% count()
a<-cbind.data.frame(a=c(1,2,3),b=c(1,2,3),c=c(1,2,3))
a
a %>% count()
a<-cbind.data.frame(a=c(1,2,3),b=c(1,3,3),c=c(1,2,3))
a
a %>% count()
a<-cbind.data.frame(a1=c(1,2,3),a2=c(1,3,3),c=c(1,2,3))
a %>% count(across(starts_with("a")))
a
a<-cbind.data.frame(a1=c(1,2,1),a2=c(1,3,3),c=c(1,2,1))
a %>% count(across(starts_with("a")))
a
a<-cbind.data.frame(a1=c(1,2,1),a2=c(1,3,1),c=c(1,2,1))
a
a %>% count(across(starts_with("a")))
data3 <- gather(data2, value, key, -n, -id)
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
plot <- ggplot(data4, aes(x = wave, y = n,
stratum = key, fill = key,
alluvium = id)) +
geom_stratum(alpha = .5) +
geom_flow() +
scale_fill_manual(values=c("red1","red3","red4", "blue1","blue3","blue4","darkslateblue", "chartreuse","chartreuse3","chartreuse4","darkgreen","yellow1","yellow2","yellow4","deeppink","deeppink4"))
plot
data2 <- datalong3 %>% count(across(starts_with("col")))%>%
mutate(id = row_number(),
n=round(n/5)*5,)
data3 <- gather(data2, value, key, -n, -id)
data4 <- data3 %>%
mutate(wave = as.numeric(str_remove(value, "col_")),
key=case_when(
key == "Eth_1" ~ "White British",
key == "Eth_2" ~ "White Irish",
key == "Eth_3" ~ "Other White",
key == "Eth_4" ~ "White and Black Caribbean",
key == "Eth_5" ~ "White and Black African",
key == "Eth_6" ~ "White and Asian",
key == "Eth_7" ~ "Other Mixed",
key == "Eth_8" ~ "Indian",
key == "Eth_9" ~ "Pakistani",
key == "Eth_10" ~ "Bangladeshi",
key == "Eth_11" ~ "Other Asian",
key == "Eth_12" ~ "Caribbean",
key == "Eth_13" ~ "African",
key == "Eth_14" ~ "Other Black",
key == "Eth_15" ~ "Chinese",
key == "Eth_16" ~ "Any other ethnic group"),
key = as.factor(key),
key = fct_relevel(key, "White British", "White Irish","Other White",
"White and Black Caribbean","White and Black African","White and Asian","Other Mixed",
"Indian","Pakistani","Bangladeshi","Other Asian",
"Caribbean","African","Other Black",
"Chinese","Any other ethnic group")  )
plot <- ggplot(data4, aes(x = wave, y = n,
stratum = key, fill = key,
alluvium = id)) +
geom_stratum(alpha = .5) +
geom_flow() +
scale_fill_manual(values=c("red1","red3","red4", "blue1","blue3","blue4","darkslateblue", "chartreuse","chartreuse3","chartreuse4","darkgreen","yellow1","yellow2","yellow4","deeppink","deeppink4"))
>>>>>>> Stashed changes
ggsave(
filename = here::here("output", "plots", "alluvial.png"),
alluvial,
dpi = 200,
width = 30,
height = 15,
units = "cm"
)
alluvial2<-alluvial_data %>%
drop_na(common) %>%
select(common,rank,patient_id) %>%
ggplot(
aes(x = rank, stratum = common, alluvium = patient_id,
fill = common, label = common)) +
scale_fill_brewer(type = "qual", palette = "Set2") +
geom_flow(stat = "alluvium", lode.guidance = "frontback",
color = "darkgray") +
geom_alluvium(aes(fill=common,alpha=0.5)) +
geom_stratum() +
theme(legend.position = "bottom") +
ggtitle("Ethnicity")
ggsave(
filename = here::here("output", "plots", "alluvial2.png"),
alluvial2,
dpi = 200,
width = 30,
height = 15,
units = "cm"
)
<<<<<<< Updated upstream
alluvial_data %>%
select(ethnicity_snomed_5 ,common) %>%
tbl_summary(by= ethnicity_snomed_5) %>%
modify_header(all_stat_cols() ~ "N={n}<br>({style_percent(p)}%)")
matches_full_table <- matches %>%
select(ethnicity_snomed_5,common) %>%
rename("this"="ethnicity_snomed_5")
tbl_summary(by= ethnicity_snomed_5,
label = list(common ~ "Most frequent",ethnicity_snomed_5 ~ "Latest")) %>%
bold_labels()
df_tab<-alluvial_data %>%
drop_na(common,ethnicity_snomed_5) %>%
group_by(ethnicity_snomed_5) %>%
mutate(n=n_distinct(patient_id),ethnicity_snomed_5=paste0(ethnicity_snomed_5,": N=",n)) %>%
select(ethnicity_snomed_5,common) %>%
tbl_summary(by= common,percent = "row")
,list(all_categorical() ~ "{n}"))
df_tab
df_tab<-alluvial_data %>%
drop_na(common,ethnicity_snomed_5) %>%
group_by(ethnicity_snomed_5) %>%
mutate(n=n_distinct(patient_id),ethnicity_snomed_5=paste0(ethnicity_snomed_5,": N=",n)) %>%
select(ethnicity_snomed_5,common) %>%
tbl_summary(by= common,statistic = all_categorical() ~ "{N}")
df_tab
df_tab<-alluvial_data %>%
drop_na(common,ethnicity_snomed_5) %>%
group_by(ethnicity_snomed_5) %>%
mutate(n=n_distinct(patient_id),ethnicity_snomed_5=paste0(ethnicity_snomed_5,": N=",n)) %>%
select(ethnicity_snomed_5,common) %>%
tbl_summary(by= common,statistic = all_categorical() ~ "{n}")
df_tab
=======
dataInp <- files %>%
map(function(x)
# # import data
read_csv(here::here("output",x)) %>%
pivot_longer(
cols = starts_with("eth_"),
names_to = "snomedcode",
names_prefix = "eth_",
values_to = "count",
values_drop_na = TRUE
) %>%
group_by(snomedcode) %>%
summarise(snomedcode_count=sum(count))) %>%
reduce(rbind)
library('tidyverse')
library('sf')
files=dir(here::here("output"),pattern = "input")
files
read_csv(here::here("output","input.csv"))
read_csv(here::here("output","input.csv")) %>% View()
read_csv(here::here("output","input.csv")) %>%   pivot_longer(
cols = starts_with("eth_"),
names_to = "snomedcode",
names_prefix = "eth_",
values_to = "count",
values_drop_na = TRUE
)
read_csv(here::here("output","input.csv")) %>%   pivot_longer(
cols = starts_with("eth_"),
names_to = "snomedcode",
names_prefix = "eth_",
values_to = "count",
values_drop_na = TRUE
) %>% View()
group_by(snomedcode) %>%
summarise(snomedcode_count=sum(count)))
read_csv(here::here("output","input.csv")) %>%   pivot_longer(
cols = starts_with("eth_"),
names_to = "snomedcode",
names_prefix = "eth_",
values_to = "count",
values_drop_na = TRUE
) %>%    group_by(snomedcode) %>%
summarise(snomedcode_count=sum(count)))
read_csv(here::here("output","input.csv")) %>%   pivot_longer(
cols = starts_with("eth_"),
names_to = "snomedcode",
names_prefix = "eth_",
values_to = "count",
values_drop_na = TRUE
) %>%    group_by(snomedcode) %>%
summarise(snomedcode_count=sum(count))
fs::dir_create(here::here("output"))
df_input <- read_csv(here::here("output","input.csv.gz")) %>%
mutate(ethnicity_snomed_5=ifelse(ethnicity_snomed_5==0,NA, ethnicity_snomed_5),
total_ctv3 = ifelse(is.na(ethnicity_5),0, 1),
total_primis = ifelse(is.na(ethnicity_snomed_5), 0, 1),
total_primis_unk = ifelse(is.na(ethnicity_primis_5_unk), 0, 1)
)
registered <- df_input %>%
filter(registered==1) %>%
summarise(ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk))
all<- df_input%>%
summarise(ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all<-as.data.frame(all)
rownames(all) <- c("All patients","Registered patients")
### count non-missing ethnicities for CTV3 and Primis codelist
library('tidyverse')
fs::dir_create(here::here("output"))
df_input <- read_csv(here::here("output","input.csv.gz")) %>%
mutate(ethnicity_snomed_5=ifelse(ethnicity_snomed_5==0,NA, ethnicity_snomed_5),
total_ctv3 = ifelse(is.na(ethnicity_5),0, 1),
total_primis = ifelse(is.na(ethnicity_snomed_5), 0, 1),
total_primis_unk = ifelse(is.na(ethnicity_primis_5_unk), 0, 1)
)
registered <- df_input %>%
filter(registered==1) %>%
summarise(ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk))
all<- df_input%>%
summarise(ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all<-as.data.frame(all)
rownames(all) <- c("All patients","Registered patients")
all
all<- df_input%>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all
registered <- df_input %>%
filter(registered==1) %>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk))
all<- df_input%>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all<-as.data.frame(all)
all
all.count <-all %>% select(-n)
all.count
all.perc <- all  %>%
mutate(round(ctv3=ctv3/n*100,0),round(primis=primis/n*100,0),round(primis_unk=primis_unk/n*100,0))
all.perc <- all  %>%
mutate(ctv3=round(ctv3/n*100,0),primis=round(primis/n*100,0),primis_unk=round(primis_unk/n*100,0))
all.perc
all.perc <- all  %>%
mutate(ctv3=round(ctv3/n*100,0),primis=round(primis/n*100,0),primis_unk=round(primis_unk/n*100,0)) %>%
select(-n)
### count non-missing ethnicities for CTV3 and Primis codelist
library('tidyverse')
fs::dir_create(here::here("output"))
df_input <- read_csv(here::here("output","input.csv.gz")) %>%
mutate(ethnicity_snomed_5=ifelse(ethnicity_snomed_5==0,NA, ethnicity_snomed_5),
total_ctv3 = ifelse(is.na(ethnicity_5),1, 0),
total_primis = ifelse(is.na(ethnicity_snomed_5), 1, 0),
total_primis_unk = ifelse(is.na(ethnicity_primis_5_unk), 1, 0)
)
registered <- df_input %>%
filter(registered==1) %>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk))
all<- df_input %>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all_perc <- all  %>%
mutate(ctv3=round(ctv3/n*100,0),primis=round(primis/n*100,0),primis_unk=round(primis_unk/n*100,0)) %>%
select(-n)
all_count <-all %>% select(-n)
write_csv(all_count,here::here("output","ctv3_primis.csv"))
write_csv(all_perc,here::here("output","ctv3_primis_perc.csv"))
v
all_count
all_perc
all_count <-all
all_perc <- all  %>%
mutate(ctv3=round(ctv3/n*100,0),primis=round(primis/n*100,0),primis_unk=round(primis_unk/n*100,0)) %>%
select(-n)
all_count
df_input <- read_csv(here::here("output","input.csv.gz")) %>%
mutate(ethnicity_snomed_5=ifelse(ethnicity_snomed_5==0,NA, ethnicity_snomed_5),
ethnicity_primis_5_unk=ifelse(ethnicity_primis_5_unk==0,NA, ethnicity_primis_5_unk),
total_ctv3 = ifelse(is.na(ethnicity_5),1, 0),
total_primis = ifelse(is.na(ethnicity_snomed_5), 1, 0),
total_primis_unk = ifelse(is.na(ethnicity_primis_5_unk), 1, 0)
)
registered <- df_input %>%
filter(registered==1) %>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk))
all<- df_input %>%
summarise(n=n(),ctv3=sum(total_ctv3),primis=sum(total_primis),primis_unk=sum(total_primis_unk)) %>%
bind_rows(registered)
all_perc <- all  %>%
mutate(ctv3=round(ctv3/n*100,0),primis=round(primis/n*100,0),primis_unk=round(primis_unk/n*100,0)) %>%
select(-n)
all_count <-all
all_count
all_perc
df_input <- read_csv(here::here("output","input.csv.gz")) %>%
mutate(ethnicity_snomed_5=ifelse(ethnicity_snomed_5==0,NA, ethnicity_snomed_5),
ethnicity_primis_5_unk=ifelse(ethnicity_primis_5_unk==0,NA, ethnicity_primis_5_unk),
total_ctv3 = ifelse(is.na(ethnicity_5),1, 0),
total_primis = ifelse(is.na(ethnicity_snomed_5), 1, 0),
total_primis_unk = ifelse(is.na(ethnicity_primis_5_unk), 1, 0)
)
View(df_input)
>>>>>>> Stashed changes
