# # import data
df_input <- arrow::read_feather(file.path(here::here("output","input.feather"))) %>%
mutate(age_band = factor(age_band,levels=c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")))
# # import data
df_input <- arrow::read_feather(file.path(here::here("output","input.feather"))) %>%
mutate(age_band = factor(age_band,levels=c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")))
## import libraries
library('tidyverse')
library('sf')
library('gtsummary')
fs::dir_create(here::here("output", "tables"))
# # import data
df_input <- arrow::read_feather(file.path(here::here("output","input.feather"))) %>%
mutate(age_band = factor(age_band,levels=c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")))
?tbl_merge
################################################################################
# Description: Script to combine TPP & ONS data for deaths, imd, and age
#
# input: /output/cohorts/input.csv.gz
#        /data/imd_ons.csv.gz
#        /data/age_ons_sex.csv.gz
#        /data/ethnicity_ons.csv.gz
#
# output: /output/tables/age_sex_count.csv.gz
#         /output/tables/age_count.csv.gz
#         /output/tables/imd_count.csv.gz
#         /output/tables/ethnic_group.csv
#
# Author: Colm D Andrews
# Date: 31/01/2022
#
################################################################################
## import libraries
library('tidyverse')
library('gtsummary')
library('ggalluvial')
fs::dir_create(here::here("output","tables"))
fs::dir_create(here::here("output","plots"))
# # import data
df_input <- arrow::read_feather(file.path(here::here("output","data","input.feather"))) %>%
mutate(age_band = factor(age_band,levels=c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")),
sex = case_when(sex=="F"~"Female",sex=="M"~"Male"),
ethnicity_snomed_5=case_when(
ethnicity_snomed_5 == "1" ~ "White",
ethnicity_snomed_5 == "2" ~ "Mixed",
ethnicity_snomed_5 == "3" ~ "Asian",
ethnicity_snomed_5 == "4" ~ "Black",
ethnicity_snomed_5 == "5" ~ "Other"),
ethnicity_5=case_when(
ethnicity_5 == "1" ~ "White",
ethnicity_5 == "2" ~ "Mixed",
ethnicity_5 == "3" ~ "Asian",
ethnicity_5 == "4" ~ "Black",
ethnicity_5 == "5" ~ "Other"))
matches<-df_input %>%
gather(common, cnt, ends_with("count")) %>%
group_by(patient_id) %>%
filter(cnt == max(cnt)) %>% # top_n(cnt, n = 1) also works
arrange(patient_id) %>%
ungroup() %>%
mutate(common = gsub("\\_.*", "", common),
match=ifelse(common==tolower(ethnicity_snomed_5),"Not matching","Matching"))
matches_table <- matches %>%
select(match,ethnicity_snomed_5) %>%
tbl_summary(by= match,
label = ethnicity_snomed_5 ~ "Latest SNOMED") %>%
bold_labels()
saveRDS(matches_table, here::here("output", "tables","matches.rds"))
matches_full_table <- matches %>%
select(common,ethnicity_snomed_5) %>%
tbl_summary(by= common,
label = list(ethnicity_snomed_5 ~ "Latest",common ~ "Most frequent")) %>%
bold_labels()
saveRDS(matches_full_table, here::here("output", "tables","matches_expanded.rds"))
definitions <- c("ctv3_yn","snomed_yn")
demographic_covariates <- c('age_band', 'sex', 'region', 'imd')
clinical_covariates <-  c('dementia', 'diabetes', 'hypertension', 'learning_disability')
set_table <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "**{level}** N =<br>{n} ({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
saveRDS(DF, here::here("output", "tables",paste0(name,".rds")))
assign(name,DF,envir = .GlobalEnv)
}
full_table<-df_input %>%
mutate(ctv3_yn = ifelse(is.na(ethnicity_5), "missing", "has value"),
snomed_yn = ifelse(is.na(ethnicity_snomed_5), "missing", "has value"),
missing = case_when(ctv3_yn =="missing" & snomed_yn=="missing" ~ "Both",
ctv3_yn =="missing" ~ "CTV3",
snomed_yn=="missing" ~ "SNOMED",
T~"Neither"),
missing = factor(missing,levels =c("Both","CTV3","SNOMED","Neither") )) %>%
mutate_at(clinical_covariates, function (x)(ifelse(x==FALSE,"False","True")))
set_table("full_missing",full_table,"snomed_yn","**Missing Ethnicity**")
set_table("full_missing_compare",full_table,"missing","**Missing Ethnicity**")
set_table("full_SNOMED",full_table,"ethnicity_snomed_5","**SNOMED Ethnicity**")
set_table("full_CTV3",full_table,"ethnicity_5","**CTV3 Ethnicity**")
#### combined SNOMED and CTV3
theme_gtsummary_compact()
ethnicity_compare<-tbl_merge( list(full_SNOMED,full_CTV3),
tab_spanner = c("**SNOMED**", "**CTV3**"))
saveRDS(ethnicity_compare, here::here("output", "tables","full_ethnicity_compare.rds"))
?tbl_merge
View(full_table)
full_table_black %>%
filter(ethnicity_snomed_5="Black")
full_table_black <- full_table %>%
filter(ethnicity_snomed_5="Black")
full_table_black <- full_table %>%
filter(ethnicity_snomed_5=="Black")
set_table("full_SNOMED_black",full_table,"ethnicity_5","**CTV3 Ethnicity**")
full_SNOMED_black
set_table("full_SNOMED_black",full_table_black,"ethnicity_5","**CTV3 Ethnicity**")
full_SNOMED_black
set_table("full_SNOMED_black",full_table_black,"ethnicity_snomed_5","**CTV3 Ethnicity**")
full_SNOMED_black
full_SNOMED
full_table_snomed_black <- full_table %>%
filter(ethnicity_snomed_5=="Black")
set_table("full_SNOMED_black",full_table_snomed_black,"ethnicity_snomed_5","**SNO**")
full_table_black <- full_table %>%
filter(ethnicity_5=="Black")
set_table("full_black",full_table_black,"ethnicity_5","**CTV3**")
ethnicity_compare<-tbl_merge( list(full_SNOMED_black,full_black))
ethnicity_compare
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5=="Black"))
set_table(paste0("full_SNOMED_",eth),paste0("full_table_snomed_",eth),"ethnicity_snomed_5","**SNO**")
}
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5=="Black"))
set_table(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
}
full_SNOMED_Black
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
ethnicity_compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White))
ethnicity_compare
ethnicity_compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",))
ethnicity_compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**"))
ethnicity_compare
ethnicity_compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**"))
ethnicity_compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**",
"**SNOMED**", "**CTV3**"))
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNO**", "**CTV3**",
"**SNO **", "**CTV3 **",
"**SNO  **", "**CTV3  **",
"**SNO   **", "**CTV3   **",
"**SNO    **", "**CTV3    **"))
compare
?tab_spanner
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**"))
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White))
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**",
"**SNO**", "**CTV3**"))  %>%
modify_spanning_header(everything() ~ NA_character_)
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOM1**", "**CTV31**",
"**SNOM2**", "**CTV32**",
"**SNOM3**", "**CTV33**",
"**SNOM4**", "**CTV34**",
"**SNOM5**", "**CTV35**"))  %>%
modify_spanning_header(everything() ~ str_sub(1,4))
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOM1**", "**CTV31**",
"**SNOM2**", "**CTV32**",
"**SNOM3**", "**CTV33**",
"**SNOM4**", "**CTV34**",
"**SNOM5**", "**CTV35**"))  %>%
modify_spanning_header(everything() ~ str_sub(.,1,4))
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOM1**", "**CTV31**",
"**SNOM2**", "**CTV32**",
"**SNOM3**", "**CTV33**",
"**SNOM4**", "**CTV34**",
"**SNOM5**", "**CTV35**"))  %>%
modify_spanning_header(everything() ~ str_sub(everything(),1,4))
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3**",
"**SNOMED<br>Black**", "**CTV3**",
"**SNOMED<br>Mixed**", "**CTV3**",
"**SNOMED<br>Other**", "**CTV3**",
"**SNOMED<br>White**", "**CTV3**"))  %>%
modify_spanning_header(everything() ~ str_sub(1,4))
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
set_table2 <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "**{n} ({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
assign(name,DF,envir = .GlobalEnv)
}
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3**",
"**SNOMED<br>Black**", "**CTV3**",
"**SNOMED<br>Mixed**", "**CTV3**",
"**SNOMED<br>Other**", "**CTV3**",
"**SNOMED<br>White**", "**CTV3**"))  #%>%
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "****",
"**SNOMED<br>Black**", "****",
"**SNOMED<br>Mixed**", "****",
"**SNOMED<br>Other**", "****",
"**SNOMED<br>White**", "****"))  #%>%
compare
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3<br>Asian**",
"**SNOMED<br>Black**", "**CTV3<br>Black**",
"**SNOMED<br>Mixed**", "**CTV3<br>Mixed**",
"**SNOMED<br>Other**", "**CTV3<br>Other**",
"**SNOMED<br>White**", "**CTV3<br>White**"))  #%>%
compare
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table2(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3<br>Asian**",
"**SNOMED<br>Black**", "**CTV3<br>Black**",
"**SNOMED<br>Mixed**", "**CTV3<br>Mixed**",
"**SNOMED<br>Other**", "**CTV3<br>Other**",
"**SNOMED<br>White**", "**CTV3<br>White**"))  #%>%
compare
set_table2 <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "** {n} ({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
assign(name,DF,envir = .GlobalEnv)
}
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table2(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare
set_table2 <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "N={n} ({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
assign(name,DF,envir = .GlobalEnv)
}
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table2(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3<br>Asian**",
"**SNOMED<br>Black**", "**CTV3<br>Black**",
"**SNOMED<br>Mixed**", "**CTV3<br>Mixed**",
"**SNOMED<br>Other**", "**CTV3<br>Other**",
"**SNOMED<br>White**", "**CTV3<br>White**"))  #%>%
compare
set_table2 <- function (name,input,variable,heading){ DF <- input %>%
select(c(all_of(variable),all_of(demographic_covariates),all_of(clinical_covariates))) %>%
tbl_summary(by= variable,
label = list(age_band ~ "Patient Age", dementia ~ "Dementia",imd ~ "IMD")) %>%
modify_header(all_stat_cols() ~ "N={n}<br>({style_percent(p)}%)") %>%
bold_labels() %>%
modify_spanning_header(all_stat_cols() ~ heading)
assign(name,DF,envir = .GlobalEnv)
}
ethnicities<-c("Asian","Black","Mixed","Other","White")
for (eth in ethnicities) {
assign(paste0("full_table_snomed_",eth),full_table %>%
filter(ethnicity_snomed_5==eth))
set_table2(paste0("full_SNOMED_",eth),get(paste0("full_table_snomed_",eth)),"ethnicity_snomed_5","**SNO**")
assign(paste0("full_table_",eth),full_table %>%
filter(ethnicity_5==eth))
set_table2(paste0("full_",eth),get(paste0("full_table_",eth)),"ethnicity_5","**CTV3**")
}
compare<-tbl_merge( list(full_SNOMED_Asian,full_Asian,
full_SNOMED_Black,full_Black,
full_SNOMED_Mixed,full_Mixed,
full_SNOMED_Other,full_Other,
full_SNOMED_White,full_White),
tab_spanner = c("**SNOMED<br>Asian**", "**CTV3<br>Asian**",
"**SNOMED<br>Black**", "**CTV3<br>Black**",
"**SNOMED<br>Mixed**", "**CTV3<br>Mixed**",
"**SNOMED<br>Other**", "**CTV3<br>Other**",
"**SNOMED<br>White**", "**CTV3<br>White**"))  #%>%
compare
saveRDS(compare, here::here("output", "tables","full_compare.rds"))
